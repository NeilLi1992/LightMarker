window.BASE_CONTAINER="ul.list-group";var helper={};helper.wrapEntry=function(b){var a=$("<a href='#' class='list-group-item'></a>");a.attr("id",b.timeStamp);
a.append($("<span class='page-title' title='"+b.pageTitle+"'></span>").text(b.pageTitle));a.append($("<span class='badge open level-0'></span>").append("<i class='icon icon-wrench'></i>"));
a.append($("<span class='badge details level-1 hide' title='详情'></span>").append("<i class='icon icon-list-alt'></i>"));a.append($("<span class='badge delete level-1 hide' title='删除'></span>").append("<i class='icon icon-trash'></i>"));
a.append($("<span class='badge confirm level-2 hide'></span>").append("<i class='icon icon-ok'></i>"));return a;};helper.activateEntry=function(b){var a=$("#"+b.timeStamp);
a.children("span.page-title").click(function(){background.openPage(b);});a.children("span.level-1").first().css("margin-right","0px");a.mouseleave(function(){$(this).children("span.badge").addClass("hide");
$(this).children("span.level-0").removeClass("hide");$(this).children("span.page-title").css("width","");});a.children("span.level-0").click(function(){$(this).siblings("span.page-title").css("width","245px");
$(this).addClass("hide");$(this).siblings("span.level-1").removeClass("hide");$(this).siblings("span.delete").click(function(){$(this).addClass("hide");
$(this).siblings("span.confirm").click(function(){console.log("删除确认按钮被点击了！");$(this).unbind("click");background.deleteEntry(b.timeStamp,function(){background.getNumberOfEntries(function(c){if(c==0){console.log("Count="+c);
changeView("allEntries","empty");}});});console.log("执行删除！");$(this).css("background-color","lightgreen");$(this).parent().fadeOut(700,function(){$(this).remove();
});}).removeClass("hide");});$(this).siblings("span.details").click(function(){$(this).unbind("click");changeView("allEntries","singleEntry",b);});});};
helper.appendEntry=function(a,b){$(a).prepend(helper.wrapEntry(b));helper.activateEntry(b);};helper.testTextOverflow=function(b,d){var c=b.children("div.data-content");
var a=c.children("span");if(a.width()>c.width()){b.append($("<i class='icon-caret-right text-roll'></i>").mouseenter(function(){$(this).css("font-size","25px").css("top","2px");
var e=0;roll=function(){e-=1;a.css("margin-left",e+"px");if(a.width()+e<c.width()){window.clearInterval(loop);}};loop=window.setInterval(roll,d);}).mouseleave(function(){$(this).css("font-size","").css("top","");
window.clearInterval(loop);a.css("margin-left","");}));}};function init(){if(background.helper.isIDBOpened()==false){console.log("IDB未打开，init 准备重入。");toggleLoadingView(BASE_CONTAINER,"show");
setTimeout(init,10);}else{toggleLoadingView("hide");$("#bookmark").click(function(){background.savePage(function(){window.close();});}).mouseenter(function(){$(this).addClass("animated pulse");
}).mouseleave(function(){$(this).removeClass("animated pulse");});$("#settings").click(function(){chrome.tabs.create({url:"http://neilli1992.github.io/LightMarker/#settings"},function(){window.close();
});}).children("i").mouseenter(function(){$(this).addClass("icon-spin");}).mouseleave(function(){$(this).removeClass("icon-spin");});background.getNumberOfEntries(function(a){if(a!=0){generateAllEntriesView(BASE_CONTAINER);
}else{generateEmptyView(BASE_CONTAINER);}});}}function toggleLoadingView(a,c){if(c==="show"){if(!document.getElementById("loading")){var b=$("<a href='#' class='list-group-item' id='loading'></a>").css("text-align","center").css("cursor","default");
b.append("<span class='prompt-text'><i class='icon-spinner icon-spin'></i>&nbsp&nbsp&nbsp&nbsp加载中...</span>");$(a).append(b);}}else{if(document.getElementById("loading")){var d=document.getElementById("loading");
d.parentNode.removeChild(d);}}}function generateEmptyView(a){var c=$("<a href='#' class='list-group-item prompt'></a>").css("cursor","default").attr("id","no-entry").append($("<span class='prompt-text'></span>").text("您目前没有保存书签！点击了解如何保存")).append("<span class='badge' style='cursor: pointer'><i class='icon-arrow-down'></i></span>");
var b=$("<a href='#' class='list-group-item prompt'></a>").css("cursor","default").attr("id","how-to-save").append($("<span class='prompt-text'></span>").text("使用快捷键Ctrl+B来保存书签。更多详情")).append("<span class='badge' style='cursor: pointer'><i class='icon-external-link'></i></span>").css("display","none");
$(a).append(c);$("#no-entry .badge").click(function(){$(this).unbind("click");$(a).append(b);$("#how-to-save").fadeIn(700).children(".badge").click(function(){chrome.tabs.create({url:"http://neilli1992.github.io/LightMarker/"},function(){window.close();
});});});}function generateAllEntriesView(b,a){if(!a){console.log("视图1 开始请求数据");background.getEntry({require:"all"},function(c){console.log("IDB数据准备完毕，回调视图1");
generateAllEntriesView(BASE_CONTAINER,c);});}else{console.log("视图1 获得数据");for(timeStamp in a){helper.appendEntry(b,a[timeStamp]);}}}function generateSingleEntryView(h){var b=$("<a href='#' class='list-group-item details editable' id='title'></a>");
b.append($("<span class='data-name'>标题</span>"));b.append($("<span class='separator'></span>"));b.append($("<div class='data-content'></div>").append($("<span title='"+h.pageTitle+"'></span>").text(h.pageTitle)));
$(BASE_CONTAINER).append(b);helper.testTextOverflow(b,15);var g=$("<a href='#' class='list-group-item details uneditable' id='url'></a>");g.append($("<span class='data-name'>地址</span>"));
g.append($("<span class='separator'></span>"));g.append($("<div class='data-content'></div>").append($("<span title='"+h.url+"'></span>").text(h.url)));
$(BASE_CONTAINER).append(g);helper.testTextOverflow(g,10);var j=new Date(h.timeStamp);var f=$("<a href='#' class='list-group-item details uneditable' id='time'></a>");
f.append($("<span class='data-name'>时间</span>"));f.append($("<span class='separator'></span>"));f.append($("<div class='data-content'></div>").append($("<span></span>").text(j.toLocaleString())));
$(BASE_CONTAINER).append(f);var c=$("<a href='#' class='list-group-item details uneditable' id='list'></a>");c.append($("<span class='data-name'>列表</span>"));
c.append($("<span class='separator'></span>"));c.append($("<div class='data-content'></div>").append($("<span></span>").text("暂不可用")));$(BASE_CONTAINER).append(c);
var d=$("<a href='#' class='list-group-item details' id='buttons'></a>");d.append($("<div><button type='button' class='btn btn-primary' id='edit'><i class='icon-pencil'></i>&nbsp修&nbsp&nbsp改</button></div>"));
d.append($("<div><button type='button' class='btn btn-primary' id='delete'><i class='icon-trash'></i>&nbsp删&nbsp&nbsp除</button></div>"));$(BASE_CONTAINER).append(d);
var e=function(){$(this).removeClass("btn-primary").addClass("btn-danger").text(" 确  认").prepend("<i class='icon-ok'></i>");$(this).mouseleave(function(){$(this).removeClass("btn-danger");
$(this).addClass("btn-primary");$(this).text(" 删 除");$(this).prepend("<i class='icon-trash'></i>");$(this).unbind("click");$(this).click(e);$(this).unbind("mouseleave");
});$(this).unbind("click");$(this).click(a);};var a=function(){console.log("即将删除！");$(this).unbind("click");$(this).unbind("mouseleave");background.deleteEntry(h.timeStamp,function(){$("button#delete").removeClass("btn-danger").addClass("btn-success");
console.log("删除成功！");background.getNumberOfEntries(function(k){if(k==0){setTimeout(function(){changeView("singleEntry","empty");},1000);}else{setTimeout(function(){changeView("singleEntry","allEntries");
},1000);}});});};$("button#delete").click(e);var i=function(){console.log("Edit!");$("a.editable i.text-roll").hide();$("a.editable").append("<i class='icon-pencil editing animated fadeInRight'></i>");
$("a.editable .data-content span").attr("contenteditable","true").css("cursor","pointer").css("display","inline-block").css("width","265px").mouseenter(function(){$("a.editable i").removeClass("fadeInRight").addClass("swing");
}).mouseleave(function(){$("a.editable i").removeClass("swing");}).blur(function(){var k=$(this).text();if(k.length==0){$("button#edit-save").addClass("disabled");
$(this).parent().siblings("i.editing").addClass("flash").one("webkitAnimationEnd mozAnimationEnd MSAnimationEnd oanimationend animationend",function(){$(this).removeClass("flash");
});}else{$("button#edit-save").removeClass("disabled");}});$("a.uneditable .data-content span").css("cursor","not-allowed");$("a#buttons").children().hide();
$("a#buttons").prepend($("<div><button type='button' class='btn btn-success' id='edit-save'><i class='icon-ok'></i>&nbsp保&nbsp&nbsp存</button></div>"));
$("a#buttons").append($("<div><button type='button' class='btn btn-danger' id='edit-cancel'><i class='icon-remove'></i>&nbsp取&nbsp&nbsp消</button></div>"));
$("button#edit-save").click(function(){console.log("点击保存！");if($("a#title .data-content span").text()!==h.pageTitle){h.pageTitle=$("a#title .data-content span").text();
background.updateEntry(h,function(){$("button#edit-cancel").click();});}else{$("button#edit-cancel").click();}});$("button#edit-cancel").click(function(){$("a.editable i.text-roll").show();
$("a.editable i.editing").addClass("fadeOutRight").one("webkitAnimationEnd mozAnimationEnd MSAnimationEnd oanimationend animationend",function(){$(this).remove();
});$("a.editable .data-content span").removeAttr("contenteditable").css("cursor","").css("display","").css("width","").unbind("mouseenter").unbind("mouseleave");
$("a.uneditable .data-content span").css("cursor","");if($("a#title .data-content span").text()!=h.pageTitle){$("a#title .data-content span").text(h.pageTitle);
}$("#edit-save, #edit-cancel").parent().remove();$("a#buttons").children().show();});};$("button#edit").click(i);}function generateAllListsView(){}function generateSingleListView(){}function generateSearchResultView(){}function changeView(b,d,a){if(b=="empty"&&d=="allEntries"){}else{if(b=="allEntries"&&d=="empty"){console.log("产生空白视图");
generateEmptyView(BASE_CONTAINER);}else{if(b=="allEntries"&&d=="singleEntry"){console.log("产生单条视图");$(BASE_CONTAINER).children().remove();var c=$("<span class='badge animated' id='back' title='返回'><i class='icon-arrow-left'></i></span>").css("position","fixed").css("left","6px").css("top","3px").mouseenter(function(){$(this).addClass("tada");
}).mouseleave(function(){$(this).removeClass("tada");}).click(function(){changeView("singleEntry","allEntries");}).fadeIn("slow");$("#tool-bar").prepend(c);
if(a){generateSingleEntryView(a);}}else{if(b=="singleEntry"&&d=="allEntries"){$(BASE_CONTAINER).children().fadeOut(function(){$(this).remove();});$("span#back").fadeOut(function(){$(this).remove();
});generateAllEntriesView(BASE_CONTAINER);}else{if(b=="singleEntry"&&d=="empty"){$(BASE_CONTAINER).children().fadeOut(function(){$(this).remove();});$("span#back").fadeOut("slow",function(){$(this).remove();
});generateEmptyView(BASE_CONTAINER);}}}}}}chrome.runtime.getBackgroundPage(function(a){window.background=a;init();});